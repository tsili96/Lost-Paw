@{
    ViewData["Title"] = "Nearby Veterinarians";
}

<h2 class="mb-4">Nearby Veterinarians</h2>

<div class="row">
    <div class="col-md-4">
        <h5>Results</h5>
        <ul id="placesList" class="list-group"></ul>
    </div>
    <div class="col-md-8">
        <div id="map" style="height: 500px; width: 100%; border-radius: 10px;"></div>
    </div>
</div>

@section Scripts {
    <script>
        let map;
        const markers = new Set(); // Prevent duplicate places

        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    map = new google.maps.Map(document.getElementById("map"), {
                        center: userLocation,
                        zoom: 14
                    });

                    // Marker for user location
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: "You are here",
                        icon: {
                            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                        }
                    });

                    const service = new google.maps.places.PlacesService(map);
                    const placesList = document.getElementById("placesList");

                    const keywords = [
                        'κτηνίατρος', 
                        'κτηνιατρείο'
                    ];

                    keywords.forEach(term => {
                        const request = {
                            location: userLocation,
                            radius: 5000, // in meters
                            keyword: term
                        };

                        service.nearbySearch(request, function (results, status) {
                            if (status === google.maps.places.PlacesServiceStatus.OK) {
                                results.forEach(place => {
                                    const key = `${place.name}-${place.geometry.location.lat()}-${place.geometry.location.lng()}`;

                                    if (!markers.has(key)) {
                                        markers.add(key);

                                        const marker = new google.maps.Marker({
                                            map: map,
                                            position: place.geometry.location,
                                            title: place.name
                                        });

                                        const infoWindow = new google.maps.InfoWindow({
                                            content: `
                                                        <div>
                                                            <strong>${place.name}</strong><br>
                                                            ${place.vicinity || ''}
                                                        </div>
                                                    `
                                        });

                                        marker.addListener("click", () => {
                                            infoWindow.open(map, marker);
                                        });

                                        // result list
                                        const listItem = document.createElement("li");
                                        listItem.classList.add("list-group-item", "list-group-item-action");
                                        listItem.innerHTML = `<strong>${place.name}</strong><br><small>${place.vicinity || ''}</small>`;

                                        listItem.addEventListener("click", () => {
                                            map.panTo(place.geometry.location);
                                            map.setZoom(15);
                                            infoWindow.open(map, marker);
                                        });

                                        placesList.appendChild(listItem);
                                    }
                                });
                            }
                        });
                    });

                }, function () {
                    alert("Could not access your location.");
                });
            } else {
                alert("Your browser does not support geolocation.");
            }
        }
    </script>

    <script async
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk1-vtByc5KCIEs4lpRUztf7qqz2nJtU8&libraries=places&callback=initMap">
    </script>
}
